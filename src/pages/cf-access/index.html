<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Access Denied - Zero Security Corp</title>
<meta name="description" content="View your Cloudflare Access and device information.">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-tertiary: #f3f4f6;
        --bg-hover: #e5e7eb;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --text-tertiary: #6b7280;
        --border-primary: #e5e7eb;
        --border-secondary: #f3f4f6;
        --accent-primary: #2563eb;
        --accent-hover: #1d4ed8;
        --accent-info: #3b82f6;
        --accent-error: #dc2626;
        --accent-warning: #f59e0b;
        --accent-success: #10b981;
        --gradient-color: rgba(220, 38, 38, 0.08);
        --icon-bg: rgba(37, 99, 235, 0.1);
        --icon-border: rgba(37, 99, 235, 0.2);
    }

    :root[data-theme="dark"] {
        --bg-primary: #000000;
        --bg-secondary: rgba(255, 255, 255, 0.02);
        --bg-tertiary: rgba(255, 255, 255, 0.03);
        --bg-hover: rgba(255, 255, 255, 0.1);
        --text-primary: #ffffff;
        --text-secondary: #9ca3af;
        --text-tertiary: #6b7280;
        --border-primary: rgba(255, 255, 255, 0.06);
        --border-secondary: rgba(255, 255, 255, 0.04);
        --accent-primary: #3080ff;
        --accent-hover: #54a2ff;
        --accent-info: #90c5ff;
        --accent-error: #ff6568;
        --accent-warning: #ffa940;
        --accent-success: #00d294;
        --gradient-color: rgba(255, 101, 104, 0.15);
        --icon-bg: rgba(48, 128, 255, 0.1);
        --icon-border: rgba(48, 128, 255, 0.3);
    }

    :root[data-theme="light"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-tertiary: #f3f4f6;
        --bg-hover: #e5e7eb;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --text-tertiary: #6b7280;
        --border-primary: #e5e7eb;
        --border-secondary: #f3f4f6;
        --accent-primary: #2563eb;
        --accent-hover: #1d4ed8;
        --accent-info: #3b82f6;
        --accent-error: #dc2626;
        --accent-warning: #f59e0b;
        --accent-success: #10b981;
        --gradient-color: rgba(220, 38, 38, 0.08);
        --icon-bg: rgba(37, 99, 235, 0.1);
        --icon-border: rgba(37, 99, 235, 0.2);
    }

    @media (prefers-color-scheme: dark) {
        :root:not([data-theme="light"]) {
            --bg-primary: #000000;
            --bg-secondary: rgba(255, 255, 255, 0.02);
            --bg-tertiary: rgba(255, 255, 255, 0.03);
            --bg-hover: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --border-primary: rgba(255, 255, 255, 0.06);
            --border-secondary: rgba(255, 255, 255, 0.04);
            --accent-primary: #3080ff;
            --accent-hover: #54a2ff;
            --accent-info: #90c5ff;
            --accent-error: #ff6568;
            --accent-warning: #ffa940;
            --accent-success: #00d294;
            --gradient-color: rgba(255, 101, 104, 0.15);
            --icon-bg: rgba(48, 128, 255, 0.1);
            --icon-border: rgba(48, 128, 255, 0.3);
        }
    }

    @media (prefers-color-scheme: light) {
        :root:not([data-theme="dark"]) {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --bg-hover: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;
            --border-primary: #e5e7eb;
            --border-secondary: #f3f4f6;
            --accent-primary: #2563eb;
            --accent-hover: #1d4ed8;
            --accent-info: #3b82f6;
            --accent-error: #dc2626;
            --accent-warning: #f59e0b;
            --accent-success: #10b981;
            --gradient-color: rgba(220, 38, 38, 0.05);
            --icon-bg: rgba(37, 99, 235, 0.1);
            --icon-border: rgba(37, 99, 235, 0.2);
        }
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, 'Noto Sans', 'Ubuntu', sans-serif;
        line-height: 1.5;
        color: var(--text-primary);
        background: var(--bg-primary);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        font-weight: 500;
        overflow-x: hidden;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .radial-gradient {
        position: absolute;
        top: 0;
        right: 20px;
        background: radial-gradient(circle, var(--gradient-color) 1%, transparent 70%);
        pointer-events: none;
        z-index: 0;
        height: 550px;
        width: 550px;
    }

    @media (min-width: 768px) {
        .radial-gradient {
            right: 56px;
            height: 650px;
            width: 650px;
        }
    }

    @media (min-width: 1024px) {
        .radial-gradient {
            height: 850px;
            width: 850px;
        }
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        position: relative;
        z-index: 1;
    }

    header {
        padding: 20px 0;
        border-bottom: 1px solid var(--border-primary);
    }

    nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .logo {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .logo svg {
        height: 24px;
        width: auto;
    }

    .theme-toggle {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        padding: 0;
    }

    .theme-toggle:hover {
        background: var(--bg-hover);
        transform: scale(1.05);
    }

    .theme-toggle svg {
        width: 20px;
        height: 20px;
        color: var(--text-secondary);
        transition: all 0.2s;
    }

    .theme-toggle:hover svg {
        color: var(--text-primary);
    }

    main {
        flex: 1;
        display: flex;
        align-items: center;
        padding: 40px 20px;
    }

    .info-container {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
    }

    .page-header {
        text-align: center;
        margin-bottom: 48px;
    }

    .page-icon {
        width: 80px;
        height: 80px;
        background: var(--icon-bg);
        border: 2px solid var(--icon-border);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
    }

    .page-icon svg {
        width: 40px;
        height: 40px;
        color: var(--accent-info);
    }

    .page-header h1 {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 12px;
        letter-spacing: -0.025em;
    }

    @media (min-width: 768px) {
        .page-header h1 {
            font-size: 42px;
        }
    }

    .page-header p {
        font-size: 16px;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
    }

    .primary-button {
        background: var(--accent-primary);
        color: white;
        padding: 12px 28px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        transition: all 0.15s;
        display: inline-flex;
        align-items: center;
        border: none;
        cursor: pointer;
    }

    .primary-button:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
    }

    .tiles-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    @media (min-width: 768px) {
        .tiles-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .tiles-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .tile {
        background: var(--bg-secondary);
        border: 1px solid var(--border-secondary);
        border-radius: 12px;
        padding: 24px;
        transition: all 0.2s;
    }

    .tile:hover {
        border-color: var(--border-primary);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .tile.error {
        background: rgba(220, 38, 38, 0.05);
        border-color: rgba(220, 38, 38, 0.2);
    }

    .tile.loading {
        opacity: 0.6;
    }

    .tile-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-secondary);
    }

    .tile-icon {
        width: 40px;
        height: 40px;
        background: var(--icon-bg);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .tile-icon svg {
        width: 20px;
        height: 20px;
        color: var(--accent-info);
    }

    .tile.error .tile-icon {
        background: rgba(220, 38, 38, 0.1);
    }

    .tile.error .tile-icon svg {
        color: var(--accent-error);
    }

    .tile-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .tile-content {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .info-label {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .info-value {
        font-size: 14px;
        color: var(--text-primary);
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        word-break: break-all;
    }

    .info-value.status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-icon {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    .status-icon.success {
        color: var(--accent-success);
    }

    .status-icon.error {
        color: var(--accent-error);
    }

    .error-message {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: rgba(220, 38, 38, 0.1);
        border-radius: 6px;
        color: var(--accent-error);
        font-size: 14px;
    }

    /* JSON Syntax Highlighting */
    .json-key {
        color: #0066cc;
        font-weight: 600;
    }

    .json-string {
        color: #22863a;
    }

    .json-number {
        color: #005cc5;
    }

    .json-boolean {
        color: #d73a49;
        font-weight: 600;
    }

    .json-null {
        color: #6f42c1;
        font-weight: 600;
    }

    [data-theme="dark"] .json-key {
        color: #79b8ff;
    }

    [data-theme="dark"] .json-string {
        color: #85e89d;
    }

    [data-theme="dark"] .json-number {
        color: #79b8ff;
    }

    [data-theme="dark"] .json-boolean {
        color: #f97583;
    }

    [data-theme="dark"] .json-null {
        color: #b392f0;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--border-primary);
        border-radius: 50%;
        border-top-color: var(--accent-primary);
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    footer {
        padding: 24px 20px;
        background: var(--bg-primary);
        border-top: 1px solid var(--border-primary);
        margin-top: auto;
    }

    .footer-content {
        text-align: center;
        color: var(--text-tertiary);
        font-size: 14px;
    }

    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 28px;
        }

        .tiles-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>
<body>
<div class="radial-gradient"></div>
<header>
    <nav class="container">
        <a href="/" class="logo">
            <svg width="120" height="53" viewBox="0 0 120 53" fill="none" xmlns="http://www.w3.org/2000/svg" style="height: 20px; width: auto;">
                <path d="M82.4133 49.8717C83.1507 47.4123 82.8698 45.1578 81.6408 43.484C80.5171 41.9469 78.621 41.0588 76.3385 40.9563L33.1128 40.4097C32.8319 40.4097 32.5861 40.2731 32.4456 40.0682C32.3052 39.8632 32.2701 39.5899 32.3403 39.3167C32.4808 38.9068 32.9021 38.5993 33.3586 38.5652L76.9706 38.0186C82.1324 37.7795 87.7507 33.7146 89.7171 28.7275L92.2102 22.4081C92.3156 22.1348 92.3507 21.8616 92.2804 21.5883C89.4713 9.22285 78.1294 0 64.5752 0C52.0745 0 41.47 7.8565 37.6777 18.7531C35.2197 16.9769 32.0945 16.0204 28.7235 16.3279C22.719 16.9086 17.9083 21.5883 17.3114 27.4294C17.1709 28.9324 17.2762 30.4012 17.6274 31.7676C7.83049 32.0409 0 39.8291 0 49.4277C0 50.2816 0.0702286 51.1356 0.175572 51.9896C0.2458 52.3995 0.596941 52.7069 1.01831 52.7069H80.7981C81.2545 52.7069 81.6759 52.3995 81.8164 51.9554L82.4133 49.8717Z" fill="#F38020"/>
                <path d="M96.1781 22.8521C95.7918 22.8521 95.3704 22.852 94.9842 22.8862C94.7033 22.8862 94.4575 23.0912 94.3521 23.3644L92.6667 29.0689C91.9293 31.5284 92.2102 33.7828 93.4392 35.4566C94.5628 36.9938 96.459 37.8819 98.7414 37.9844L107.941 38.5309C108.222 38.5309 108.468 38.6675 108.609 38.8725C108.749 39.0774 108.784 39.3849 108.714 39.624C108.573 40.0339 108.152 40.3413 107.696 40.3755L98.1094 40.922C92.9125 41.1611 87.3293 45.226 85.3629 50.2132L84.6606 51.9553C84.5201 52.2969 84.7659 52.6384 85.1522 52.6384H118.089C118.476 52.6384 118.827 52.3993 118.932 52.0236C119.494 50.0424 119.81 47.9587 119.81 45.8067C119.81 33.168 109.205 22.8521 96.1781 22.8521Z" fill="#FAAE40"/>
            </svg>
            Zero Security Corp
        </a>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
            <svg id="theme-icon-sun" style="display: none;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg id="theme-icon-moon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
    </nav>
</header>

<main>
    <div class="container">
        <div class="info-container">
            <div class="page-header">
                <div class="page-icon" style="background: rgba(220, 38, 38, 0.1); border-color: rgba(220, 38, 38, 0.2);">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #dc2626;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h1 class="text-heading-24 mt-8 mb-4">Access Denied</h1>
                <p class="text-sm text-gray-900 m-0">Your access attempt has been logged. Review your authentication details and device posture status below. If you believe this is an error, contact IT support.</p>
                <button role="button" onclick="reloadApplication()" tabindex="0" class="inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-black text-white hover:bg-gray-800 focus-visible:ring-gray-900" style="margin-top: 20px; --geist-icon-size:16px">
                    <svg style="width: 16px; height: 16px; margin-right: 8px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>Reload Access Application</span>
                </button>
            </div>

            <div class="tiles-grid">
                <div class="tile loading" id="warp-tile">
                    <div class="tile-header">
                        <div class="tile-icon" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2);">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #10b981;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <h2 class="text-heading-16 font-medium m-0 w-max whitespace-nowrap overflow-hidden text-ellipsis flex-1 mr-0">User Information</h2>
                    </div>
                    <div class="tile-content" id="warp-content">
                        <div style="text-align: center; padding: 20px;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <div class="tile loading" id="device-tile">
                    <div class="tile-header">
                        <div class="tile-icon" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.2);">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #3b82f6;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <h2 class="text-heading-16 font-medium m-0 w-max whitespace-nowrap overflow-hidden text-ellipsis flex-1 mr-0">Device Information</h2>
                    </div>
                    <div class="tile-content" id="device-content">
                        <div style="text-align: center; padding: 20px;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <div class="tile loading" id="posture-tile">
                    <div class="tile-header">
                        <div class="tile-icon" style="background: rgba(168, 85, 247, 0.1); border-color: rgba(168, 85, 247, 0.2);">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #a855f7;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <h2 class="text-heading-16 font-medium m-0 w-max whitespace-nowrap overflow-hidden text-ellipsis flex-1 mr-0">Device Posture</h2>
                    </div>
                    <div class="tile-content" id="posture-content">
                        <div style="text-align: center; padding: 20px;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug Section - Full Width -->
            <div class="tile" id="debug-tile" style="margin-top: 20px; grid-column: 1 / -1;">
                <div class="tile-header" style="cursor: pointer; display: flex; align-items: center;" onclick="toggleDebug()">
                    <div class="tile-icon">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                        </svg>
                    </div>
                    <h2 class="text-heading-16 font-medium m-0 w-max whitespace-nowrap overflow-hidden text-ellipsis flex-1 mr-0">Debug Information</h2>
                    <svg id="debug-toggle" style="margin-left: auto; width: 20px; height: 20px; transition: transform 0.2s;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div class="tile-content" id="debug-content" style="display: none;">
                    <pre id="debug-json" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; overflow: auto; font-size: 13px; line-height: 1.6; max-height: 600px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; margin: 0; white-space: pre-wrap; word-wrap: break-word;"></pre>
                </div>
            </div>
        </div>
    </div>
</main>

<footer>
    <div class="container">
        <div class="footer-content">
            2026 Zero Security Corp. Protected by Cloudflare Access
        </div>
    </div>
</footer>

<script src="/cf-access/scripts/warpinfo.js"></script>
<script src="/cf-access/scripts/deviceinfo.js"></script>
<script src="/cf-access/scripts/postureinfo.js"></script>
<script>
    const themeToggle = document.getElementById('theme-toggle');
    const sunIcon = document.getElementById('theme-icon-sun');
    const moonIcon = document.getElementById('theme-icon-moon');
    const html = document.documentElement;

    const savedTheme = localStorage.getItem('theme');
    
    if (savedTheme) {
        html.setAttribute('data-theme', savedTheme);
    } else {
        html.setAttribute('data-theme', 'light');
    }

    function updateThemeIcon() {
        const currentTheme = html.getAttribute('data-theme');
        if (currentTheme === 'light') {
            sunIcon.style.display = 'block';
            moonIcon.style.display = 'none';
        } else {
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'block';
        }
    }

    updateThemeIcon();

    themeToggle.addEventListener('click', () => {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon();
    });

    function toggleDebug() {
        const content = document.getElementById('debug-content');
        const toggle = document.getElementById('debug-toggle');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.style.transform = 'rotate(180deg)';
        } else {
            content.style.display = 'none';
            toggle.style.transform = 'rotate(0deg)';
        }
    }

    function reloadApplication() {
        // Get original URL from query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const originalUrl = urlParams.get('original_url');
        
        if (originalUrl) {
            // Decode the URL in case it's URL-encoded
            let decodedUrl = decodeURIComponent(originalUrl);
            
            // Ensure the URL has a protocol to prevent relative URL interpretation
            if (!decodedUrl.startsWith('http://') && !decodedUrl.startsWith('https://')) {
                decodedUrl = 'https://' + decodedUrl;
            }
            
            // Use location.replace to navigate to the original URL
            window.location.replace(decodedUrl);
        } else {
            window.location.reload();
        }
    }

    function renderWarpInfo(data) {
        const tile = document.getElementById('warp-tile');
        const content = document.getElementById('warp-content');
        
        tile.classList.remove('loading');
        
        if (data.error) {
            tile.classList.add('error');
            content.innerHTML = `
                <div class="error-message">
                    <svg class="status-icon error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>${data.error}</span>
                </div>
            `;
            return;
        }

        const userGroups = Array.isArray(data.userGroups) ? data.userGroups.join(', ') : (data.userGroups || 'None');
        const warpStatus = data.isWarpEnabled ? 'Enabled' : 'Disabled';
        const warpIcon = data.isWarpEnabled ? 
            '<svg class="status-icon success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>' :
            '<svg class="status-icon error" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';

        content.innerHTML = `
            <div class="info-item">
                <div class="info-label">Full Name</div>
                <div class="info-value">${data.userName || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value">${data.userEmail || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">WARP Status</div>
                <div class="info-value status">
                    ${warpIcon}
                    <span>${warpStatus}</span>
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">User Groups</div>
                <div class="info-value">${userGroups}</div>
            </div>
        `;
    }

    function renderDeviceInfo(data) {
        const tile = document.getElementById('device-tile');
        const content = document.getElementById('device-content');
        
        tile.classList.remove('loading');
        
        if (data.error) {
            tile.classList.add('error');
            content.innerHTML = `
                <div class="error-message">
                    <svg class="status-icon error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>${data.error}</span>
                </div>
            `;
            return;
        }

        content.innerHTML = `
            <div class="info-item">
                <div class="info-label">Device ID</div>
                <div class="info-value">${data.deviceId || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Device Name</div>
                <div class="info-value">${data.deviceName || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Model</div>
                <div class="info-value">${data.deviceModel || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">OS Version</div>
                <div class="info-value">${data.deviceOsVersion || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Serial Number</div>
                <div class="info-value">${data.deviceSerial || 'N/A'}</div>
            </div>
        `;
    }

    function renderPostureInfo(data) {
        const tile = document.getElementById('posture-tile');
        const content = document.getElementById('posture-content');
        
        tile.classList.remove('loading');
        
        if (data.error) {
            tile.classList.add('error');
            content.innerHTML = `
                <div class="error-message">
                    <svg class="status-icon error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>${data.error}</span>
                </div>
            `;
            return;
        }

        const crowdstrikeStatus = data.crowdstrikeEnabled ? 'Running' : 'Not Detected';
        const crowdstrikeIcon = data.crowdstrikeEnabled ? 
            '<svg class="status-icon success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>' :
            '<svg class="status-icon error" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
        
        const osUpdateStatus = data.osUpToDate ? 'Up to Date' : 'Update Required';
        const osUpdateIcon = data.osUpToDate ? 
            '<svg class="status-icon success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>' :
            '<svg class="status-icon warning" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>';

        content.innerHTML = `
            <div class="info-item">
                <div class="info-label">Crowdstrike Status</div>
                <div class="info-value status">
                    ${crowdstrikeIcon}
                    <span>${crowdstrikeStatus}</span>
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">OS Update Status</div>
                <div class="info-value status">
                    ${osUpdateIcon}
                    <span>${osUpdateStatus}</span>
                </div>
            </div>
        `;
    }

    // Function to syntax highlight JSON for better readability
    function syntaxHighlightJSON(obj) {
        const json = JSON.stringify(obj, null, 2);
        return json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
            .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
    }

    // Function to extract device_id from JWT token
    function getDeviceIdFromToken(jwt) {
        const [header, payload, signature] = jwt.split(".");
        if (payload) {
            try {
                const decoded = JSON.parse(
                    atob(payload.replace(/_/g, "/").replace(/-/g, "+"))
                );
                return decoded.device_id || null;
            } catch (error) {
                return null;
            }
        }
        return null;
    }

    async function loadData() {
        try {
            // Fetch combined user details (identity + device + posture)
            const userDetailsResponse = await fetch('/cf-access/api/userdetails');
            
            if (!userDetailsResponse.ok) {
                throw new Error(`User details fetch failed: ${userDetailsResponse.status}`);
            }
            
            const combinedData = await userDetailsResponse.json();
            
            // Extract data from combined response
            const identityData = combinedData.identity || {};
            const apiDeviceData = combinedData.device || {};
            const apiPostureData = combinedData.posture || {};
            
            // Extract device_id from JWT token
            let deviceId = null;
            const cookies = document.cookie.split(';');
            const cfAuthCookie = cookies.find(c => c.trim().startsWith('CF_Authorization='));
            if (cfAuthCookie) {
                const token = cfAuthCookie.split('=')[1];
                deviceId = getDeviceIdFromToken(token);
            }
            
            // Display combined data in debug section with syntax highlighting
            const debugJson = document.getElementById('debug-json');
            const debugData = {
                identity: identityData,
                device: apiDeviceData,
                posture: apiPostureData,
                deviceIdFromJWT: deviceId
            };
            debugJson.innerHTML = syntaxHighlightJSON(debugData);
            
            // Process data with individual error handling
            const [warpData, deviceData, postureData] = await Promise.all([
                Promise.resolve().then(() => getWarpInfo(identityData)).catch(err => {
                    return { error: 'Failed to load user information' };
                }),
                Promise.resolve().then(() => getDeviceInfo(identityData, deviceId, apiDeviceData)).catch(err => {
                    return { error: 'Failed to load device information' };
                }),
                Promise.resolve().then(() => getPostureInfo(identityData, apiPostureData)).catch(err => {
                    return { error: 'Failed to load posture information' };
                })
            ]);

            renderWarpInfo(warpData);
            renderDeviceInfo(deviceData);
            renderPostureInfo(postureData);
        } catch (error) {
            const debugJson = document.getElementById('debug-json');
            debugJson.innerHTML = syntaxHighlightJSON({ 
                error: error.message, 
                stack: error.stack 
            });
            
            renderWarpInfo({ error: 'Failed to load user information' });
            renderDeviceInfo({ error: 'Failed to load device information' });
            renderPostureInfo({ error: 'Failed to load posture information' });
        }
    }

    loadData();
</script>
</body>
</html>
