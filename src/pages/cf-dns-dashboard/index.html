<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DNS Analytics Dashboard - Zero Security Corp</title>
<meta name="description" content="Comprehensive DNS query analytics and monitoring for Zero Trust Gateway traffic.">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 53'%3E%3Cpath d='M82.4133 49.8717C83.1507 47.4123 82.8698 45.1578 81.6408 43.484C80.5171 41.9469 78.621 41.0588 76.3385 40.9563L33.1128 40.4097C32.8319 40.4097 32.5861 40.2731 32.4456 40.0682C32.3052 39.8632 32.2701 39.5899 32.3403 39.3167C32.4808 38.9068 32.9021 38.5993 33.3586 38.5652L76.9706 38.0186C82.1324 37.7795 87.7507 33.7146 89.7171 28.7275L92.2102 22.4081C92.3156 22.1348 92.3507 21.8616 92.2804 21.5883C89.4713 9.22285 78.1294 0 64.5752 0C52.0745 0 41.47 7.8565 37.6777 18.7531C35.2197 16.9769 32.0945 16.0204 28.7235 16.3279C22.719 16.9086 17.9083 21.5883 17.3114 27.4294C17.1709 28.9324 17.2762 30.4012 17.6274 31.7676C7.83049 32.0409 0 39.8291 0 49.4277C0 50.2816 0.0702286 51.1356 0.175572 51.9896C0.2458 52.3995 0.596941 52.7069 1.01831 52.7069H80.7981C81.2545 52.7069 81.6759 52.3995 81.8164 51.9554L82.4133 49.8717Z' fill='%23F38020'/%3E%3Cpath d='M96.1781 22.8521C95.7918 22.8521 95.3704 22.852 94.9842 22.8862C94.7033 22.8862 94.4575 23.0912 94.3521 23.3644L92.6667 29.0689C91.9293 31.5284 92.2102 33.7828 93.4392 35.4566C94.5628 36.9938 96.459 37.8819 98.7414 37.9844L107.941 38.5309C108.222 38.5309 108.468 38.6675 108.609 38.8725C108.749 39.0774 108.784 39.3849 108.714 39.624C108.573 40.0339 108.152 40.3413 107.696 40.3755L98.1094 40.922C92.9125 41.1611 87.3293 45.226 85.3629 50.2132L84.6606 51.9553C84.5201 52.2969 84.7659 52.6384 85.1522 52.6384H118.089C118.476 52.6384 118.827 52.3993 118.932 52.0236C119.494 50.0424 119.81 47.9587 119.81 45.8067C119.81 33.168 109.205 22.8521 96.1781 22.8521Z' fill='%23FAAE40'/%3E%3C/svg%3E">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-tertiary: #f3f4f6;
        --bg-hover: #e5e7eb;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --text-tertiary: #6b7280;
        --border-primary: #e5e7eb;
        --border-secondary: #f3f4f6;
        --accent-primary: #2563eb;
        --accent-hover: #1d4ed8;
        --accent-info: #3b82f6;
        --accent-error: #dc2626;
        --accent-warning: #f59e0b;
        --accent-success: #10b981;
        --gradient-color: rgba(37, 99, 235, 0.08);
        --icon-bg: rgba(37, 99, 235, 0.1);
        --icon-border: rgba(37, 99, 235, 0.2);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: var(--bg-secondary);
        color: var(--text-primary);
        line-height: 1.5;
        transition: background-color 0.3s ease, color 0.3s ease;
        min-height: 100vh;
    }

    header {
        padding: 16px 0;
        border-bottom: 1px solid var(--border-primary);
        background: var(--bg-primary);
    }

    nav {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .logo {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .logo svg {
        height: 20px;
        width: auto;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
    }

    .page-header {
        text-align: center;
        margin-bottom: 24px;
        padding: 16px 0;
    }

    .page-header h1 {
        color: var(--text-primary);
        font-size: 1.75rem;
        margin-bottom: 6px;
        font-weight: 700;
    }

    .page-header p {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    .controls {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 8px 16px;
        border: 1px solid var(--border-primary);
        background: var(--bg-primary);
        color: var(--text-primary);
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Roboto Mono', monospace;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent-primary);
    }

    .btn.active {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
    }

    .live-btn {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .live-btn.active {
        background: var(--accent-error);
        border-color: var(--accent-error);
    }

    .live-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-tertiary);
    }

    .live-btn.active .live-indicator {
        background: white;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    .metric-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: var(--bg-primary);
        padding: 16px 20px;
        border-radius: 8px;
        border: 1px solid var(--border-primary);
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stat-card:hover {
        border-color: var(--accent-primary);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .stat-card-title {
        font-family: 'Roboto Mono', monospace;
        color: rgb(95, 99, 104);
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .stat-card-value {
        font-family: 'Roboto Mono', monospace;
        color: var(--text-primary);
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }

    .stat-card-subtitle {
        font-family: 'Roboto Mono', monospace;
        color: rgb(95, 99, 104);
        font-size: 0.85rem;
        font-weight: 400;
    }

    .card {
        background: var(--bg-primary);
        border-radius: 8px;
        border: 1px solid var(--border-primary);
        padding: 16px 20px;
        margin-bottom: 16px;
        transition: all 0.2s ease;
    }

    .card h2 {
        font-family: 'Roboto Mono', monospace;
        color: rgb(95, 99, 104);
        font-size: 0.9rem;
        margin-bottom: 12px;
        font-weight: 600;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 12px;
        overflow-x: hidden;
    }

    .tooltip-overlay {
        position: absolute;
        z-index: 60;
        background: var(--bg-primary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        font-family: 'Roboto Mono', monospace;
        font-size: 0.8rem;
        color: rgb(95, 99, 104);
        max-width: 300px;
        pointer-events: none;
    }

    .info-btn {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 1.5px solid rgb(95, 99, 104);
        background: transparent;
        color: rgb(95, 99, 104);
        font-family: 'Roboto Mono', monospace;
        font-size: 12px;
        font-weight: 600;
        font-style: italic;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .info-btn:hover {
        background: rgb(95, 99, 104);
        color: white;
    }

    .donut-chart-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        height: 100%;
        overflow: hidden;
    }

    .donut-chart-container {
        position: relative;
        width: 200px;
        height: 200px;
        flex-shrink: 0;
    }

    .donut-chart-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        pointer-events: none;
        z-index: 1;
    }

    .donut-chart-container canvas {
        position: relative;
        z-index: 2;
    }

    .donut-chart-center .total-count {
        font-family: 'Roboto Mono', monospace;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .donut-chart-center .total-label {
        font-family: 'Roboto Mono', monospace;
        font-size: 0.7rem;
        color: rgb(95, 99, 104);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 4px;
    }

    .chart-legend {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 240px;
        max-width: 240px;
        max-height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
        flex-shrink: 0;
    }

    .chart-legend-entry {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.15s ease;
    }

    .chart-legend-entry:hover {
        background: var(--bg-tertiary);
    }

    .chart-legend-color {
        width: 10px;
        height: 10px;
        border-radius: 2px;
        flex-shrink: 0;
    }

    .chart-legend-label {
        font-family: 'Roboto Mono', monospace;
        font-size: 0.6rem;
        color: rgb(95, 99, 104);
        width: 130px;
        min-width: 130px;
        max-width: 130px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chart-legend-count {
        font-family: 'Roboto Mono', monospace;
        font-size: 0.55rem;
        font-weight: 600;
        color: var(--text-primary);
        background: var(--bg-tertiary);
        padding: 2px 5px;
        border-radius: 8px;
        white-space: nowrap;
        flex-shrink: 0;
        margin-left: auto;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background-color: var(--bg-primary);
        margin: 5% auto;
        padding: 30px;
        border: 1px solid var(--border-primary);
        border-radius: 12px;
        width: 90%;
        max-width: 900px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-header h2 {
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 600;
    }

    .close {
        color: var(--text-secondary);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .close:hover {
        color: var(--accent-error);
    }

    .table-container {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .table thead {
        background: var(--bg-secondary);
    }

    .table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid var(--border-primary);
    }

    .table td {
        padding: 12px;
        border-bottom: 1px solid var(--border-primary);
        color: var(--text-primary);
    }

    .table tbody tr:hover {
        background: var(--bg-hover);
    }

    @media (max-width: 768px) {
        .header h1 {
            font-size: 1.5rem;
        }

        .stat-card-value {
            font-size: 2rem;
        }

        .modal-content {
            width: 95%;
            margin: 10% auto;
            padding: 20px;
        }
    }
</style>
</head>
<body>
<header>
    <nav>
        <a href="/" class="logo" style="width: 220px; flex-shrink: 0;">
            <svg width="40" height="18" viewBox="0 0 120 53" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M82.4133 49.8717C83.1507 47.4123 82.8698 45.1578 81.6408 43.484C80.5171 41.9469 78.621 41.0588 76.3385 40.9563L33.1128 40.4097C32.8319 40.4097 32.5861 40.2731 32.4456 40.0682C32.3052 39.8632 32.2701 39.5899 32.3403 39.3167C32.4808 38.9068 32.9021 38.5993 33.3586 38.5652L76.9706 38.0186C82.1324 37.7795 87.7507 33.7146 89.7171 28.7275L92.2102 22.4081C92.3156 22.1348 92.3507 21.8616 92.2804 21.5883C89.4713 9.22285 78.1294 0 64.5752 0C52.0745 0 41.47 7.8565 37.6777 18.7531C35.2197 16.9769 32.0945 16.0204 28.7235 16.3279C22.719 16.9086 17.9083 21.5883 17.3114 27.4294C17.1709 28.9324 17.2762 30.4012 17.6274 31.7676C7.83049 32.0409 0 39.8291 0 49.4277C0 50.2816 0.0702286 51.1356 0.175572 51.9896C0.2458 52.3995 0.596941 52.7069 1.01831 52.7069H80.7981C81.2545 52.7069 81.6759 52.3995 81.8164 51.9554L82.4133 49.8717Z" fill="#F38020"/>
                <path d="M96.1781 22.8521C95.7918 22.8521 95.3704 22.852 94.9842 22.8862C94.7033 22.8862 94.4575 23.0912 94.3521 23.3644L92.6667 29.0689C91.9293 31.5284 92.2102 33.7828 93.4392 35.4566C94.5628 36.9938 96.459 37.8819 98.7414 37.9844L107.941 38.5309C108.222 38.5309 108.468 38.6675 108.609 38.8725C108.749 39.0774 108.784 39.3849 108.714 39.624C108.573 40.0339 108.152 40.3413 107.696 40.3755L98.1094 40.922C92.9125 41.1611 87.3293 45.226 85.3629 50.2132L84.6606 51.9553C84.5201 52.2969 84.7659 52.6384 85.1522 52.6384H118.089C118.476 52.6384 118.827 52.3993 118.932 52.0236C119.494 50.0424 119.81 47.9587 119.81 45.8067C119.81 33.168 109.205 22.8521 96.1781 22.8521Z" fill="#FAAE40"/>
            </svg>
            <span style="font-family: 'Roboto Mono', monospace; font-weight: 600; font-size: 0.85rem; color: var(--text-primary);">Zero Security Corp</span>
        </a>
        <div style="text-align: center; flex: 1;">
            <h1 style="font-family: 'Roboto Mono', monospace; font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 0;">DNS Analytics Dashboard</h1>
            <p style="font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: var(--text-tertiary); margin: 2px 0 0 0;">Real-time insights into DNS traffic patterns and security trends</p>
        </div>
        <div style="width: 220px;"></div>
    </nav>
</header>

    <div class="container">
        <div style="display: flex; gap: 16px;">
            <!-- Left Sidebar - Quick Stats -->
            <div style="width: 220px; flex-shrink: 0; margin-top: 44px;">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="stat-card">
                        <div class="stat-card-title">Total Queries</div>
                        <div class="stat-card-value" style="font-size: 1.5rem;" id="totalQueries">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Allowed Queries</div>
                        <div class="stat-card-value" id="allowedQueries" style="color: var(--accent-success); font-size: 1.5rem;">-</div>
                        <div class="stat-card-subtitle" id="allowedPercent">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Blocked Queries</div>
                        <div class="stat-card-value" id="blockedQueries" style="color: var(--accent-error); font-size: 1.5rem;">-</div>
                        <div class="stat-card-subtitle" id="blockedPercent">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Top Blocked Source Geo</div>
                        <div class="stat-card-value" style="font-size: 1rem; color: var(--accent-error); word-break: break-all;" id="topCountryBlocked">-</div>
                        <div class="stat-card-subtitle" id="topCountryBlockedCount">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Top Query Source Geo</div>
                        <div class="stat-card-value" style="font-size: 1rem; word-break: break-all;" id="topCountryQueries">-</div>
                        <div class="stat-card-subtitle" id="topCountryQueriesCount">-</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div style="flex: 1; min-width: 0;">
                <div style="display: flex; justify-content: center; margin-bottom: 12px;">
                    <div class="controls" style="gap: 8px;">
                        <button class="btn live-btn" onclick="toggleLiveMode()" id="liveBtn">
                            <span class="live-indicator" id="liveIndicator"></span>
                            <span id="liveBtnText">Live</span>
                        </button>
                        <button class="btn" onclick="changeTimeRange('1h')">Last 1 Hour</button>
                        <button class="btn" onclick="changeTimeRange('24h')">Last 24 Hours</button>
                        <button class="btn active" onclick="changeTimeRange('7d')">Last 7 Days</button>
                        <button class="btn" onclick="changeTimeRange('30d')">Last 30 Days</button>
                    </div>
                </div>
                <div id="liveStatus" style="display: none; text-align: center; margin-bottom: 12px; font-family: 'Roboto Mono', monospace; font-size: 0.8rem; color: var(--text-secondary);">
                    <span id="liveStatusText">Refreshing in <span id="countdown">10</span>s</span>
                    <span style="margin-left: 12px;">|</span>
                    <span id="dataTimeRange" style="margin-left: 12px;">Data: --</span>
                </div>
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2 style="margin: 0;">üìà DNS Query Timeline</h2>
                        <span id="timelinePeriod" style="font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: var(--text-secondary);">Last 7 Days</span>
                    </div>
                    <div class="chart-container" style="height: 180px;">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>

                <!-- Live DNS Logs Table - Only visible in Live mode -->
                <div id="liveLogsContainer" class="card" style="margin-bottom: 16px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2 style="margin: 0;">üî¥ Live DNS Logs</h2>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="logCount" style="font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: var(--text-secondary);">0 logs</span>
                            <button onclick="clearLogs()" class="btn" style="padding: 4px 12px; font-size: 0.75rem;">Clear</button>
                        </div>
                    </div>
                    <div id="liveLogsTable" style="max-height: 300px; overflow-y: auto; font-family: 'Roboto Mono', monospace; font-size: 0.75rem;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: var(--bg-primary); z-index: 1;">
                                <tr style="border-bottom: 1px solid var(--border-primary);">
                                    <th style="text-align: left; padding: 8px 12px; color: var(--text-secondary); font-weight: 500;">Time</th>
                                    <th style="text-align: left; padding: 8px 12px; color: var(--text-secondary); font-weight: 500;">Domain</th>
                                    <th style="text-align: left; padding: 8px 12px; color: var(--text-secondary); font-weight: 500;">Category</th>
                                    <th style="text-align: left; padding: 8px 12px; color: var(--text-secondary); font-weight: 500;">Policy</th>
                                    <th style="text-align: right; padding: 8px 12px; color: var(--text-secondary); font-weight: 500;">Count</th>
                                    <th style="text-align: left; padding: 8px 12px; color: var(--text-secondary); font-weight: 500;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="liveLogsBody">
                                <!-- Logs will be appended here -->
                            </tbody>
                        </table>
                        <div id="noLogsMessage" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            Waiting for DNS queries...
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2 style="margin: 0;">üåç DNS Queries by Geography</h2>
                            <button onclick="showQueryInfo('geography')" class="info-btn" title="View GraphQL Query">i</button>
                        </div>
                        <div class="chart-container" id="geographyChartContainer" style="height: 200px;">
                            <canvas id="geographyChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2 style="margin: 0;">üìä DNS Queries by Category</h2>
                            <button onclick="showQueryInfo('category')" class="info-btn" title="View GraphQL Query">i</button>
                        </div>
                        <div class="chart-container" id="categoryChartContainer" style="height: 200px;">
                            <canvas id="categoryFilteredChart"></canvas>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2 style="margin: 0;">‚ö° DNS Action Breakdown</h2>
                            <button onclick="showQueryInfo('action')" class="info-btn" title="View GraphQL Query">i</button>
                        </div>
                        <div class="chart-container" id="actionBreakdownChartContainer" style="height: 200px;">
                            <canvas id="actionBreakdownChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2 style="margin: 0;">üì± Application Summary</h2>
                            <button onclick="showQueryInfo('applications')" class="info-btn" title="View GraphQL Query">i</button>
                        </div>
                        <div class="chart-container" id="applicationsChartContainer" style="height: 200px;">
                            <canvas id="applicationsPieChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Category Analysis Section -->
                <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(139, 92, 246, 0.02) 100%); border: 1px solid rgba(139, 92, 246, 0.2); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, rgb(139, 92, 246), rgb(109, 40, 217)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>
                        </div>
                        <h2 style="margin: 0; font-family: 'Roboto Mono', monospace; color: var(--text-primary); font-size: 1.1rem; font-weight: 700;">Category Analysis</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h2 style="margin: 0;">Top 20 Allowed Categories</h2>
                                <button onclick="showQueryInfo('allowed')" class="info-btn" title="View GraphQL Query">i</button>
                            </div>
                            <div class="chart-container" style="height: 450px;">
                                <canvas id="allowedChart"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h2 style="margin: 0;">Top 20 Blocked Categories</h2>
                                <button onclick="showQueryInfo('blocked')" class="info-btn" title="View GraphQL Query">i</button>
                            </div>
                            <div id="blockedChartContainer" class="chart-container" style="height: 450px;">
                                <canvas id="blockedChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Domain Analysis Section -->
                <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.02) 100%); border: 1px solid rgba(59, 130, 246, 0.2); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, rgb(59, 130, 246), rgb(37, 99, 235)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
                        </div>
                        <h2 style="margin: 0; font-family: 'Roboto Mono', monospace; color: var(--text-primary); font-size: 1.1rem; font-weight: 700;">Domain Analysis</h2>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h2 style="margin: 0;">Top 20 Queried Domains</h2>
                                <button onclick="showQueryInfo('queries')" class="info-btn" title="View GraphQL Query">i</button>
                            </div>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="queriesChart"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h2 style="margin: 0;">Top 20 Blocked Domains</h2>
                                <button onclick="showQueryInfo('blockedDomains')" class="info-btn" title="View GraphQL Query">i</button>
                            </div>
                            <div id="blockedDomainsChartContainer" class="chart-container" style="height: 250px;">
                                <canvas id="blockedDomainsChart"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h2 style="margin: 0;">Top 20 Newly Observed Domains</h2>
                                <button onclick="showQueryInfo('newlyObserved')" class="info-btn" title="View GraphQL Query">i</button>
                            </div>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="newlyObservedChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let allowedChart = null;
        let blockedChart = null;
        let queriesChart = null;
        let geographyChart = null;
        let categoryFilteredChart = null;
        let actionBreakdownChart = null;
        let timelineChart = null;
        let applicationsPieChart = null;
        let newlyObservedChart = null;
        let blockedDomainsChart = null;
        let currentTimeRange = '7d';
        let isLiveMode = false;
        let liveInterval = null;
        let countdownInterval = null;
        let countdownValue = 10;
        const LIVE_REFRESH_SECONDS = 10;
        let lastLogTimestamp = null;
        let allLogs = [];
        const MAX_LOGS = 200;

        function toggleLiveMode() {
            isLiveMode = !isLiveMode;
            const liveBtn = document.getElementById('liveBtn');
            const liveStatus = document.getElementById('liveStatus');
            const liveBtnText = document.getElementById('liveBtnText');
            const liveLogsContainer = document.getElementById('liveLogsContainer');
            
            if (isLiveMode) {
                // Enable live mode
                liveBtn.classList.add('active');
                liveBtnText.textContent = 'Stop';
                liveStatus.style.display = 'block';
                liveLogsContainer.style.display = 'block';
                
                // Clear previous logs
                allLogs = [];
                lastLogTimestamp = null;
                renderLogs();
                
                // Remove active from other buttons
                document.querySelectorAll('.controls .btn:not(.live-btn)').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Load data immediately with 5-minute range
                currentTimeRange = '5m';
                loadDashboardData('5m');
                fetchLiveLogs();
                
                // Start countdown
                countdownValue = LIVE_REFRESH_SECONDS;
                updateCountdown();
                countdownInterval = setInterval(() => {
                    countdownValue--;
                    updateCountdown();
                    if (countdownValue <= 0) {
                        countdownValue = LIVE_REFRESH_SECONDS;
                        loadDashboardData('5m');
                        fetchLiveLogs();
                    }
                }, 1000);
            } else {
                // Disable live mode
                liveBtn.classList.remove('active');
                liveBtnText.textContent = 'Live';
                liveStatus.style.display = 'none';
                liveLogsContainer.style.display = 'none';
                
                // Clear intervals
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                
                // Reset to 7d view
                currentTimeRange = '7d';
                document.querySelectorAll('.controls .btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.includes('7 Days')) {
                        btn.classList.add('active');
                    }
                });
                loadDashboardData('7d');
            }
        }

        function updateCountdown() {
            const countdownEl = document.getElementById('countdown');
            if (countdownEl) {
                countdownEl.textContent = countdownValue;
            }
        }

        function changeTimeRange(range) {
            // Stop live mode if active
            if (isLiveMode) {
                isLiveMode = false;
                const liveBtn = document.getElementById('liveBtn');
                const liveStatus = document.getElementById('liveStatus');
                const liveBtnText = document.getElementById('liveBtnText');
                const liveLogsContainer = document.getElementById('liveLogsContainer');
                liveBtn.classList.remove('active');
                liveBtnText.textContent = 'Live';
                liveStatus.style.display = 'none';
                liveLogsContainer.style.display = 'none';
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
            }
            
            currentTimeRange = range;
            
            document.querySelectorAll('.controls .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadDashboardData(range);
        }

        function loadDashboardData(timeRange = '7d') {
            // Update timeline period indicator
            const periodLabels = {
                '5m': 'Recent 5 Minutes',
                '1h': 'Last 1 Hour',
                '24h': 'Last 24 Hours',
                '7d': 'Last 7 Days',
                '30d': 'Last 30 Days'
            };
            const timelinePeriod = document.getElementById('timelinePeriod');
            if (timelinePeriod) {
                timelinePeriod.textContent = periodLabels[timeRange] || timeRange;
            }

            // Update data time range display for live mode
            if (timeRange === '5m') {
                const now = new Date();
                const startTime = new Date(now.getTime() - 5 * 60 * 1000);
                const formatTime = (d) => d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const dataTimeRange = document.getElementById('dataTimeRange');
                if (dataTimeRange) {
                    dataTimeRange.textContent = `Data: ${formatTime(startTime)} - ${formatTime(now)}`;
                }
            }

            document.getElementById('totalQueries').textContent = '-';
            document.getElementById('allowedQueries').textContent = '-';
            document.getElementById('blockedQueries').textContent = '-';
            document.getElementById('allowedPercent').textContent = '-';
            document.getElementById('blockedPercent').textContent = '-';
            document.getElementById('topCountryQueries').textContent = '-';
            document.getElementById('topCountryQueriesCount').textContent = '-';
            document.getElementById('topCountryBlocked').textContent = '-';
            document.getElementById('topCountryBlockedCount').textContent = '-';

            Promise.all([
                fetch('/dns/api/monthly-stats?timeRange=' + timeRange).then(r => r.json()),
                fetch('/dns/api/30day?timeRange=' + timeRange).then(r => r.json()),
                fetch('/dns/api/top-allowed?timeRange=' + timeRange).then(r => r.json()),
                fetch('/dns/api/top-blocked?timeRange=' + timeRange).then(r => r.json()),
                fetch('/dns/api/top-queries?timeRange=' + timeRange).then(r => r.json()),
                fetch('/dns/api/geography?timeRange=' + timeRange).then(r => r.json()),
                fetch('/dns/api/category-filtered?timeRange=' + timeRange).then(r => r.json()),
                fetch('/dns/api/geography-blocked?timeRange=' + timeRange).then(r => r.json()).catch(() => []),
                fetch('/dns/api/applications-pie?timeRange=' + timeRange).then(r => r.json()).catch(() => []),
                fetch('/dns/api/newly-observed?timeRange=' + timeRange).then(r => r.json()).catch(() => []),
                fetch('/dns/api/blocked-domains?timeRange=' + timeRange).then(r => r.json()).catch(() => [])
            ]).then(([stats, trendData, allowedData, blockedData, queriesData, geoData, categoryData, geoBlockedData, applicationsData, newlyObservedData, blockedDomainsData]) => {
                updateMetrics(stats);
                updateTopCountryStats(geoData, geoBlockedData);
                renderTimelineChart(trendData, timeRange);
                renderAllowedChart(allowedData);
                renderBlockedChart(blockedData);
                renderQueriesChart(queriesData);
                renderGeographyChart(geoData);
                renderCategoryFilteredChart(categoryData);
                renderActionBreakdownChart(trendData);
                renderApplicationsPieChart(applicationsData);
                renderNewlyObservedChart(newlyObservedData);
                renderBlockedDomainsChart(blockedDomainsData);
            }).catch(err => {
                console.error('Error loading dashboard data:', err);
            });
        }

        function updateTopCountryStats(geoData, geoBlockedData) {
            if (geoData && geoData.length > 0) {
                const topCountry = geoData[0];
                document.getElementById('topCountryQueries').textContent = topCountry.country;
                document.getElementById('topCountryQueriesCount').textContent = topCountry.count.toLocaleString() + ' queries';
            }
            if (geoBlockedData && geoBlockedData.length > 0) {
                const topBlocked = geoBlockedData[0];
                document.getElementById('topCountryBlocked').textContent = topBlocked.country;
                document.getElementById('topCountryBlockedCount').textContent = topBlocked.count.toLocaleString() + ' blocked';
            } else {
                document.getElementById('topCountryBlocked').textContent = 'None';
                document.getElementById('topCountryBlockedCount').textContent = 'All clear!';
            }
        }

        function updateMetrics(data) {
            const total = data.totalQueries || 0;
            const allowed = data.allowedQueries || 0;
            const blocked = data.blockedQueries || 0;
            const allowedPercent = total > 0 ? ((allowed / total) * 100).toFixed(1) : 0;
            const blockedPercent = total > 0 ? ((blocked / total) * 100).toFixed(1) : 0;

            document.getElementById('totalQueries').textContent = total.toLocaleString();
            document.getElementById('allowedQueries').textContent = allowed.toLocaleString();
            document.getElementById('allowedPercent').textContent = allowedPercent + '% of total';
            document.getElementById('blockedQueries').textContent = blocked.toLocaleString();
            document.getElementById('blockedPercent').textContent = blockedPercent + '% of total';
        }

        const allClearHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-success); opacity: 0.6; margin-bottom: 12px;"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"></path></svg>
                <div style="font-family: 'Roboto Mono', monospace; font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">All Clear!</div>
                <div style="font-family: 'Roboto Mono', monospace; font-size: 0.8rem; color: rgb(95, 99, 104);">No blocked domains detected during this period</div>
                <div style="font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: var(--accent-success); margin-top: 4px;">Your DNS security is working perfectly</div>
            </div>
        `;

        function renderTimelineChart(data, timeRange = '7d') {
            if (timelineChart) timelineChart.destroy();

            const canvas = document.getElementById('timelineChart');
            if (!canvas) return;
            const container = canvas.parentElement;
            if (!container) return;

            container.innerHTML = '<canvas id="timelineChart"></canvas>';

            const newCanvas = document.getElementById('timelineChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            // Create a map of existing data
            const dataMap = {};
            if (data && data.length > 0) {
                data.forEach(d => {
                    dataMap[d.date] = (d.allowed || 0) + (d.blocked || 0) + (d.safeSearch || 0) + (d.overrideApplied || 0) + (d.unknown || 0);
                });
            }

            // Generate complete time series with 0 for missing periods
            const labels = [];
            const totalQueries = [];
            const now = new Date();

            if (timeRange === '5m') {
                // Generate last 5 minutes in 1-minute intervals (5 points)
                for (let i = 4; i >= 0; i--) {
                    const minuteDate = new Date(now);
                    minuteDate.setMinutes(now.getMinutes() - i, 0, 0);
                    
                    // Find matching data point (compare by minute)
                    let found = 0;
                    Object.keys(dataMap).forEach(key => {
                        const dataDate = new Date(key);
                        if (dataDate.getFullYear() === minuteDate.getFullYear() &&
                            dataDate.getMonth() === minuteDate.getMonth() &&
                            dataDate.getDate() === minuteDate.getDate() &&
                            dataDate.getHours() === minuteDate.getHours() &&
                            dataDate.getMinutes() === minuteDate.getMinutes()) {
                            found = dataMap[key];
                        }
                    });
                    
                    labels.push(minuteDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }));
                    totalQueries.push(found);
                }
            } else if (timeRange === '1h') {
                // Generate last 60 minutes in 5-minute intervals (12 points)
                for (let i = 11; i >= 0; i--) {
                    const minuteDate = new Date(now);
                    minuteDate.setMinutes(now.getMinutes() - (i * 5), 0, 0);
                    
                    // Find matching data point (compare by hour since API returns hourly data)
                    let found = 0;
                    Object.keys(dataMap).forEach(key => {
                        const dataDate = new Date(key);
                        if (dataDate.getFullYear() === minuteDate.getFullYear() &&
                            dataDate.getMonth() === minuteDate.getMonth() &&
                            dataDate.getDate() === minuteDate.getDate() &&
                            dataDate.getHours() === minuteDate.getHours()) {
                            found = dataMap[key];
                        }
                    });
                    
                    labels.push(minuteDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }));
                    totalQueries.push(found);
                }
            } else if (timeRange === '24h') {
                // Generate all 24 hours
                for (let i = 23; i >= 0; i--) {
                    const hourDate = new Date(now);
                    hourDate.setHours(now.getHours() - i, 0, 0, 0);
                    const hourKey = hourDate.toISOString();
                    
                    // Find matching data point (compare by hour)
                    let found = 0;
                    Object.keys(dataMap).forEach(key => {
                        const dataDate = new Date(key);
                        if (dataDate.getFullYear() === hourDate.getFullYear() &&
                            dataDate.getMonth() === hourDate.getMonth() &&
                            dataDate.getDate() === hourDate.getDate() &&
                            dataDate.getHours() === hourDate.getHours()) {
                            found = dataMap[key];
                        }
                    });
                    
                    labels.push(hourDate.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }));
                    totalQueries.push(found);
                }
            } else {
                // Generate all days for 7d or 30d
                const days = timeRange === '7d' ? 7 : 30;
                for (let i = days - 1; i >= 0; i--) {
                    const dayDate = new Date(now);
                    dayDate.setDate(now.getDate() - i);
                    dayDate.setHours(0, 0, 0, 0);
                    const dayKey = dayDate.toISOString().split('T')[0];
                    
                    labels.push(dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    totalQueries.push(dataMap[dayKey] || 0);
                }
            }

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Queries',
                        data: totalQueries,
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgb(37, 99, 235)',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            grid: { color: 'rgba(95, 99, 104, 0.1)' },
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' }
                        },
                        y: { 
                            beginAtZero: true,
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { color: 'rgba(95, 99, 104, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            backgroundColor: '#ffffff',
                            titleColor: '#111827',
                            bodyColor: 'rgb(95, 99, 104)',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { family: "'Roboto Mono', monospace", weight: '600' },
                            bodyFont: { family: "'Roboto Mono', monospace" }
                        }
                    }
                }
            });
        }

        function renderAllowedChart(data) {
            if (allowedChart) allowedChart.destroy();

            const canvas = document.getElementById('allowedChart');
            if (!canvas) return;
            const container = canvas.parentElement;
            if (!container) return;

            container.innerHTML = '<canvas id="allowedChart"></canvas>';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No data available for this time period.</div>';
                return;
            }

            const newCanvas = document.getElementById('allowedChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            allowedChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.category),
                    datasets: [{
                        label: 'Queries',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgb(92, 184, 255)',
                        borderRadius: 3
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { color: 'rgba(95, 99, 104, 0.1)' }
                        },
                        y: {
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            titleFont: { family: "'Roboto Mono', monospace" },
                            bodyFont: { family: "'Roboto Mono', monospace" }
                        }
                    }
                }
            });
        }

        function renderBlockedChart(data) {
            if (blockedChart) blockedChart.destroy();

            const container = document.getElementById('blockedChartContainer');
            if (!container) return;

            container.innerHTML = '<canvas id="blockedChart"></canvas>';

            if (!data || data.length === 0) {
                container.innerHTML = allClearHTML;
                return;
            }

            const newCanvas = document.getElementById('blockedChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            blockedChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.category),
                    datasets: [{
                        label: 'Queries',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgb(242, 214, 67)',
                        borderRadius: 3
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { color: 'rgba(95, 99, 104, 0.1)' }
                        },
                        y: {
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            titleFont: { family: "'Roboto Mono', monospace" },
                            bodyFont: { family: "'Roboto Mono', monospace" }
                        }
                    }
                }
            });
        }

        function renderQueriesChart(data) {
            if (queriesChart) queriesChart.destroy();

            const canvas = document.getElementById('queriesChart');
            if (!canvas) return;
            const container = canvas.parentElement;
            if (!container) return;

            container.innerHTML = '<canvas id="queriesChart"></canvas>';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No data available for this time period.</div>';
                return;
            }

            const newCanvas = document.getElementById('queriesChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            const chartData = data;
            queriesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.query),
                    datasets: [{
                        label: 'Queries',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgb(92, 184, 255)',
                        borderRadius: 3
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { color: 'rgba(95, 99, 104, 0.1)' }
                        },
                        y: {
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            titleFont: { family: "'Roboto Mono', monospace" },
                            bodyFont: { family: "'Roboto Mono', monospace" },
                            callbacks: {
                                afterBody: function(context) {
                                    const index = context[0].dataIndex;
                                    const categories = chartData[index]?.categories || [];
                                    if (categories.length > 0) {
                                        return ['', 'Categories: ' + categories.join(', ')];
                                    }
                                    return [];
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderNewlyObservedChart(data) {
            if (newlyObservedChart) newlyObservedChart.destroy();

            const canvas = document.getElementById('newlyObservedChart');
            if (!canvas) return;
            const container = canvas.parentElement;
            if (!container) return;

            container.innerHTML = '<canvas id="newlyObservedChart"></canvas>';

            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-success); opacity: 0.6; margin-bottom: 12px;"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"></path></svg>
                        <div style="font-family: 'Roboto Mono', monospace; font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">No New Domains</div>
                        <div style="font-family: 'Roboto Mono', monospace; font-size: 0.8rem; color: rgb(95, 99, 104);">No newly observed domains in this time period</div>
                    </div>
                `;
                return;
            }

            const newCanvas = document.getElementById('newlyObservedChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            const chartData = data;
            newlyObservedChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.query),
                    datasets: [{
                        label: 'Queries',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgb(92, 184, 255)',
                        borderRadius: 3
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { color: 'rgba(95, 99, 104, 0.1)' }
                        },
                        y: {
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            titleFont: { family: "'Roboto Mono', monospace" },
                            bodyFont: { family: "'Roboto Mono', monospace" },
                            callbacks: {
                                afterBody: function(context) {
                                    const index = context[0].dataIndex;
                                    const categories = chartData[index]?.categories || [];
                                    if (categories.length > 0) {
                                        return ['', 'Categories: ' + categories.join(', ')];
                                    }
                                    return [];
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderBlockedDomainsChart(data) {
            if (blockedDomainsChart) blockedDomainsChart.destroy();

            const container = document.getElementById('blockedDomainsChartContainer');
            if (!container) return;

            container.innerHTML = '<canvas id="blockedDomainsChart"></canvas>';

            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-success); opacity: 0.6; margin-bottom: 12px;"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"></path></svg>
                        <div style="font-family: 'Roboto Mono', monospace; font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">All Clear!</div>
                        <div style="font-family: 'Roboto Mono', monospace; font-size: 0.8rem; color: rgb(95, 99, 104);">No blocked domains in this time period</div>
                    </div>
                `;
                return;
            }

            const newCanvas = document.getElementById('blockedDomainsChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            const chartData = data;
            blockedDomainsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.query),
                    datasets: [{
                        label: 'Blocked',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgb(242, 214, 67)',
                        borderRadius: 3
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { color: 'rgba(95, 99, 104, 0.1)' }
                        },
                        y: {
                            ticks: { font: { family: "'Roboto Mono', monospace", size: 10 }, color: 'rgb(95, 99, 104)' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            titleFont: { family: "'Roboto Mono', monospace" },
                            bodyFont: { family: "'Roboto Mono', monospace" },
                            callbacks: {
                                afterBody: function(context) {
                                    const index = context[0].dataIndex;
                                    const categories = chartData[index]?.categories || [];
                                    if (categories.length > 0) {
                                        return ['', 'Categories: ' + categories.join(', ')];
                                    }
                                    return [];
                                }
                            }
                        }
                    }
                }
            });
        }

        async function showQueryDetails(date, type, timeRange, resolverDecisions) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modal.style.display = 'block';
            modalTitle.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Queries - ${date}`;
            modalContent.innerHTML = '<div class="loading">Loading details...</div>';
            
            try {
                const decisionsParam = resolverDecisions ? `&decisions=${resolverDecisions.join(',')}` : '';
                const response = await fetch(`/dns/api/query-details?date=${encodeURIComponent(date)}&type=${type}&timeRange=${timeRange}${decisionsParam}`);
                const data = await response.json();
                
                if (data.error) {
                    modalContent.innerHTML = `<div style="color: var(--accent-error); text-align: center; padding: 20px;">${data.error}</div>`;
                    return;
                }
                
                if (!data.queries || data.queries.length === 0) {
                    modalContent.innerHTML = '<div class="loading">No queries found for this time period.</div>';
                    return;
                }
                
                let html = `
                    <table style="width: 100%; border-collapse: collapse; font-family: 'Roboto Mono', monospace; font-size: 0.8rem;">
                        <thead>
                            <tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-primary);">
                                <th style="padding: 10px; text-align: left; font-weight: 600;">Domain</th>
                                <th style="padding: 10px; text-align: left; font-weight: 600;">Policy</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600;">Count</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.queries.forEach(item => {
                    html += `
                        <tr style="border-bottom: 1px solid var(--border-primary);">
                            <td style="padding: 8px 10px; word-break: break-all;">${item.queryName}</td>
                            <td style="padding: 8px 10px;"><span style="background: rgba(139, 92, 246, 0.1); color: rgb(139, 92, 246); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${item.policyName}</span></td>
                            <td style="padding: 8px 10px; text-align: right; font-weight: 500;">${item.count.toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                modalContent.innerHTML = html;
            } catch (error) {
                modalContent.innerHTML = `<div style="color: var(--accent-error); text-align: center; padding: 20px;">Error loading data: ${error.message}</div>`;
            }
        }

        async function showQueryDetails(date, type, timeRange, resolverDecisions) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modal.style.display = 'block';
            modalTitle.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Queries - ${date}`;
            modalContent.innerHTML = '<div class="loading">Loading details...</div>';
            
            try {
                const decisionsParam = resolverDecisions ? `&decisions=${resolverDecisions.join(',')}` : '';
                const response = await fetch(`/dns/api/query-details?date=${encodeURIComponent(date)}&type=${type}&timeRange=${timeRange}${decisionsParam}`);
                const data = await response.json();
                
                if (data.error) {
                    modalContent.innerHTML = `<div style="color: var(--accent-error); text-align: center; padding: 20px;">${data.error}</div>`;
                    return;
                }
                
                if (!data.categories || data.categories.length === 0) {
                    modalContent.innerHTML = '<div class="loading">No queries found for this time period.</div>';
                    return;
                }
                
                let html = '<div class="table-container">';
                
                data.categories.forEach(category => {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: var(--text-primary); font-size: 1.1rem; margin-bottom: 10px; font-weight: 600;">
                                ${category.name} (${category.totalQueries.toLocaleString()} queries)
                            </h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Domain</th>
                                        <th style="text-align: right;">Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    category.queries.forEach(query => {
                        html += `
                            <tr>
                                <td style="color: var(--text-primary); font-family: monospace; font-size: 0.9rem;">${query.domain}</td>
                                <td style="text-align: right; color: var(--text-secondary);">${query.count.toLocaleString()}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                html += '</div>';
                modalContent.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading query details:', error);
                modalContent.innerHTML = '<div style="color: var(--accent-error); text-align: center; padding: 20px;">Failed to load query details</div>';
            }
        }

        function renderGeographyChart(data) {
            if (geographyChart) geographyChart.destroy();

            const container = document.getElementById('geographyChartContainer');
            if (!container) return;

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No data available for this time period.</div>';
                return;
            }

            populateCountryDropdown(data);

            const chartData = data;
            const total = chartData.reduce((sum, d) => sum + d.count, 0);

            const donutColors = [
                'rgb(73, 146, 88)', 'rgb(255, 166, 0)', 'rgb(170, 110, 198)', 
                'rgb(255, 108, 110)', 'rgb(43, 118, 185)', 'rgb(220, 101, 180)',
                'rgb(255, 97, 149)', 'rgb(100, 181, 246)', 'rgb(129, 199, 132)',
                'rgb(255, 183, 77)', 'rgb(158, 158, 158)', 'rgb(121, 85, 72)',
                'rgb(0, 150, 136)', 'rgb(63, 81, 181)', 'rgb(233, 30, 99)'
            ];

            container.innerHTML = `
                <div class="donut-chart-wrapper">
                    <div class="donut-chart-container">
                        <canvas id="geographyChart"></canvas>
                        <div class="donut-chart-center">
                            <div class="total-count">${total.toLocaleString()}</div>
                            <div class="total-label">Total</div>
                        </div>
                    </div>
                    <div class="chart-legend" id="geographyLegend"></div>
                </div>
            `;

            const newCanvas = document.getElementById('geographyChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            geographyChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.map(d => d.country),
                    datasets: [{
                        data: chartData.map(d => d.count),
                        backgroundColor: donutColors.slice(0, chartData.length),
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#ffffff',
                        hoverOffset: 15,
                        cutout: '60%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            backgroundColor: '#ffffff',
                            titleColor: '#111827',
                            bodyColor: 'rgb(95, 99, 104)',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { family: "'Roboto Mono', monospace", weight: '600' },
                            bodyFont: { family: "'Roboto Mono', monospace" },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': ' + value.toLocaleString() + ' (' + percent + '%)';
                                }
                            }
                        }
                    },
                    onClick: async function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const country = chartData[index].country;
                            await showGeographyDetails(country);
                        }
                    }
                }
            });

            const legendContainer = document.getElementById('geographyLegend');
            legendContainer.innerHTML = '';
            chartData.forEach((item, index) => {
                const percent = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                const entry = document.createElement('div');
                entry.className = 'chart-legend-entry';
                entry.innerHTML = `
                    <div class="chart-legend-color" style="background-color: ${donutColors[index % donutColors.length]};"></div>
                    <div class="chart-legend-label">${item.country}</div>
                    <span class="chart-legend-count">${item.count.toLocaleString()} (${percent}%)</span>
                `;
                entry.onclick = () => showGeographyDetails(item.country);
                legendContainer.appendChild(entry);
            });
        }

        async function showGeographyDetails(country) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modal.style.display = 'block';
            modalTitle.textContent = `DNS Queries from ${country}`;
            modalContent.innerHTML = '<div class="loading">Loading details...</div>';
            
            try {
                const response = await fetch(`/dns/api/geography-details?country=${encodeURIComponent(country)}&timeRange=${currentTimeRange}`);
                const data = await response.json();
                
                if (data.error) {
                    modalContent.innerHTML = `<div style="color: var(--accent-error); text-align: center; padding: 20px;">${data.error}</div>`;
                    return;
                }
                
                const blockRate = data.totalQueries > 0 ? ((data.blockedQueries / data.totalQueries) * 100).toFixed(2) : '0.00';
                
                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary);">${data.totalQueries.toLocaleString()}</div>
                                <div style="font-size: 0.9rem; color: var(--text-tertiary);">Total Queries</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-error);">${data.blockedQueries.toLocaleString()}</div>
                                <div style="font-size: 0.9rem; color: var(--text-tertiary);">Blocked</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-warning);">${blockRate}%</div>
                                <div style="font-size: 0.9rem; color: var(--text-tertiary);">Block Rate</div>
                            </div>
                        </div>
                    </div>
                    <h3 style="color: var(--text-primary); margin-bottom: 15px;">Top Queried Domains</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th style="text-align: right;">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.queries.forEach(query => {
                    html += `
                        <tr>
                            <td style="color: var(--text-primary); font-family: monospace; font-size: 0.9rem;">${query.query}</td>
                            <td style="text-align: right; color: var(--text-secondary);">${query.count.toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                modalContent.innerHTML = html;
            } catch (error) {
                console.error('Error loading geography details:', error);
                modalContent.innerHTML = '<div style="color: var(--accent-error); text-align: center; padding: 20px;">Failed to load details</div>';
            }
        }

        function renderCategoryFilteredChart(data) {
            if (categoryFilteredChart) categoryFilteredChart.destroy();

            const container = document.getElementById('categoryChartContainer');
            if (!container) return;

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No data available for this time period.</div>';
                return;
            }

            const chartData = data.slice(0, 10);
            const total = chartData.reduce((sum, d) => sum + d.count, 0);

            const donutColors = [
                'rgb(73, 146, 88)', 'rgb(255, 166, 0)', 'rgb(170, 110, 198)', 
                'rgb(255, 108, 110)', 'rgb(43, 118, 185)', 'rgb(220, 101, 180)',
                'rgb(255, 97, 149)', 'rgb(100, 181, 246)', 'rgb(129, 199, 132)',
                'rgb(255, 183, 77)'
            ];

            container.innerHTML = `
                <div class="donut-chart-wrapper">
                    <div class="donut-chart-container">
                        <canvas id="categoryFilteredChart"></canvas>
                        <div class="donut-chart-center">
                            <div class="total-count">${total.toLocaleString()}</div>
                            <div class="total-label">Total</div>
                        </div>
                    </div>
                    <div class="chart-legend" id="categoryLegend"></div>
                </div>
            `;

            const newCanvas = document.getElementById('categoryFilteredChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            categoryFilteredChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.map(d => d.category),
                    datasets: [{
                        data: chartData.map(d => d.count),
                        backgroundColor: donutColors,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#ffffff',
                        hoverOffset: 15,
                        cutout: '60%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            backgroundColor: '#ffffff',
                            titleColor: '#111827',
                            bodyColor: 'rgb(95, 99, 104)',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { family: "'Roboto Mono', monospace", weight: '600' },
                            bodyFont: { family: "'Roboto Mono', monospace" },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': ' + value.toLocaleString() + ' (' + percent + '%)';
                                }
                            }
                        }
                    }
                }
            });

            const legendContainer = document.getElementById('categoryLegend');
            legendContainer.innerHTML = '';
            chartData.forEach((item, index) => {
                const percent = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                const entry = document.createElement('div');
                entry.className = 'chart-legend-entry';
                entry.innerHTML = `
                    <div class="chart-legend-color" style="background-color: ${donutColors[index]};"></div>
                    <div class="chart-legend-label">${item.category}</div>
                    <span class="chart-legend-count">${item.count.toLocaleString()} (${percent}%)</span>
                `;
                legendContainer.appendChild(entry);
            });
        }

        function renderActionBreakdownChart(trendData) {
            if (actionBreakdownChart) actionBreakdownChart.destroy();

            const container = document.getElementById('actionBreakdownChartContainer');
            if (!container) return;

            if (!trendData || trendData.length === 0) {
                container.innerHTML = allClearHTML;
                return;
            }

            // Aggregate trend data into action breakdown totals
            const actionTotals = {
                'Allowed': 0,
                'Blocked': 0,
                'Safe Search': 0,
                'Override Applied': 0,
                'Unknown': 0
            };

            trendData.forEach(d => {
                actionTotals['Allowed'] += d.allowed || 0;
                actionTotals['Blocked'] += d.blocked || 0;
                actionTotals['Safe Search'] += d.safeSearch || 0;
                actionTotals['Override Applied'] += d.overrideApplied || 0;
                actionTotals['Unknown'] += d.unknown || 0;
            });

            // Convert to array and filter out zeros
            const chartData = Object.entries(actionTotals)
                .filter(([_, count]) => count > 0)
                .map(([action, count]) => ({ action, count }));

            if (chartData.length === 0) {
                container.innerHTML = allClearHTML;
                return;
            }

            const total = chartData.reduce((sum, d) => sum + d.count, 0);

            const donutColors = [
                'rgb(73, 146, 88)', 'rgb(255, 108, 110)', 'rgb(255, 166, 0)', 
                'rgb(170, 110, 198)', 'rgb(95, 99, 104)'
            ];

            container.innerHTML = `
                <div class="donut-chart-wrapper">
                    <div class="donut-chart-container">
                        <canvas id="actionBreakdownChart"></canvas>
                        <div class="donut-chart-center">
                            <div class="total-count">${total.toLocaleString()}</div>
                            <div class="total-label">Total</div>
                        </div>
                    </div>
                    <div class="chart-legend" id="actionLegend"></div>
                </div>
            `;

            const newCanvas = document.getElementById('actionBreakdownChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            actionBreakdownChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.map(d => d.action),
                    datasets: [{
                        data: chartData.map(d => d.count),
                        backgroundColor: donutColors.slice(0, chartData.length),
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#ffffff',
                        hoverOffset: 15,
                        cutout: '60%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            backgroundColor: '#ffffff',
                            titleColor: '#111827',
                            bodyColor: 'rgb(95, 99, 104)',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { family: "'Roboto Mono', monospace", weight: '600' },
                            bodyFont: { family: "'Roboto Mono', monospace" },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': ' + value.toLocaleString() + ' (' + percent + '%)';
                                }
                            }
                        }
                    },
                    onClick: async function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const actionType = chartData[index].action;
                            await showActionDetails(actionType);
                        }
                    }
                }
            });

            const legendContainer = document.getElementById('actionLegend');
            chartData.forEach((item, index) => {
                const percent = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                const entry = document.createElement('div');
                entry.className = 'chart-legend-entry';
                entry.innerHTML = `
                    <div class="chart-legend-color" style="background-color: ${donutColors[index]};"></div>
                    <div class="chart-legend-label">${item.action}</div>
                    <span class="chart-legend-count">${item.count.toLocaleString()} (${percent}%)</span>
                `;
                entry.onclick = () => showActionDetails(item.action);
                legendContainer.appendChild(entry);
            });
        }

        function renderApplicationsPieChart(data) {
            if (applicationsPieChart) applicationsPieChart.destroy();

            const container = document.getElementById('applicationsChartContainer');
            if (!container) return;

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No application data available.</div>';
                return;
            }

            const chartData = data.slice(0, 10);
            const total = chartData.reduce((sum, d) => sum + d.count, 0);

            const donutColors = [
                'rgb(43, 118, 185)', 'rgb(73, 146, 88)', 'rgb(255, 166, 0)', 
                'rgb(170, 110, 198)', 'rgb(255, 108, 110)', 'rgb(220, 101, 180)',
                'rgb(255, 97, 149)', 'rgb(100, 181, 246)', 'rgb(129, 199, 132)',
                'rgb(255, 183, 77)'
            ];

            container.innerHTML = `
                <div class="donut-chart-wrapper">
                    <div class="donut-chart-container">
                        <canvas id="applicationsPieChart"></canvas>
                        <div class="donut-chart-center">
                            <div class="total-count">${total.toLocaleString()}</div>
                            <div class="total-label">Total</div>
                        </div>
                    </div>
                    <div class="chart-legend" id="applicationsLegend"></div>
                </div>
            `;

            const newCanvas = document.getElementById('applicationsPieChart');
            if (!newCanvas) return;
            const ctx = newCanvas.getContext('2d');

            applicationsPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.map(d => d.application),
                    datasets: [{
                        data: chartData.map(d => d.count),
                        backgroundColor: donutColors,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#ffffff',
                        hoverOffset: 15,
                        cutout: '60%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            backgroundColor: '#ffffff',
                            titleColor: '#111827',
                            bodyColor: 'rgb(95, 99, 104)',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { family: "'Roboto Mono', monospace", weight: '600' },
                            bodyFont: { family: "'Roboto Mono', monospace" },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': ' + value.toLocaleString() + ' (' + percent + '%)';
                                }
                            }
                        }
                    }
                }
            });

            const legendContainer = document.getElementById('applicationsLegend');
            legendContainer.innerHTML = '';
            chartData.forEach((item, index) => {
                const percent = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                const entry = document.createElement('div');
                entry.className = 'chart-legend-entry';
                entry.innerHTML = `
                    <div class="chart-legend-color" style="background-color: ${donutColors[index]};"></div>
                    <div class="chart-legend-label">${item.application}</div>
                    <span class="chart-legend-count">${item.count.toLocaleString()} (${percent}%)</span>
                `;
                legendContainer.appendChild(entry);
            });
        }

        async function showCategoryQueryModal(categoryName, categoryId) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modal.style.display = 'block';
            modalTitle.textContent = `Queries in ${categoryName}`;
            modalContent.innerHTML = '<div class="loading">Loading queries...</div>';
            
            try {
                const response = await fetch(`/dns/api/category-queries?categoryId=${categoryId}&timeRange=${currentTimeRange}`);
                const data = await response.json();
                
                if (data.error) {
                    modalContent.innerHTML = `<div style="color: var(--accent-error); text-align: center; padding: 20px;">${data.error}</div>`;
                    return;
                }
                
                if (!data || data.length === 0) {
                    modalContent.innerHTML = '<div class="loading">No queries found for this category.</div>';
                    return;
                }
                
                let html = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th>Policy</th>
                                    <th style="text-align: right;">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(query => {
                    html += `
                        <tr>
                            <td style="color: var(--text-primary); font-family: monospace; font-size: 0.9rem;">${query.domain}</td>
                            <td style="color: var(--text-tertiary); font-size: 0.85rem;">${query.policyName}</td>
                            <td style="text-align: right; color: var(--text-secondary);">${query.count.toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                modalContent.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading category queries:', error);
                modalContent.innerHTML = '<div style="color: var(--accent-error); text-align: center; padding: 20px;">Failed to load queries</div>';
            }
        }

        async function showActionDetails(actionType) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modal.style.display = 'block';
            modalTitle.textContent = `${actionType} Queries`;
            modalContent.innerHTML = '<div class="loading">Loading details...</div>';
            
            // Map action type to resolver decisions
            let resolverDecisions = [];
            if (actionType === 'Allowed') {
                resolverDecisions = [1, 4, 5, 10];
            } else if (actionType === 'Blocked') {
                resolverDecisions = [2, 3, 6, 9];
            } else if (actionType === 'Safe Search') {
                resolverDecisions = [7];
            } else if (actionType === 'Override Applied') {
                resolverDecisions = [8];
            } else if (actionType === 'Unknown') {
                resolverDecisions = [0];
            }
            
            try {
                const response = await fetch(`/dns/api/action-details?timeRange=${currentTimeRange}&decisions=${resolverDecisions.join(',')}`);
                const data = await response.json();
                
                if (data.error) {
                    modalContent.innerHTML = `<div style="color: var(--accent-error); text-align: center; padding: 20px;">${data.error}</div>`;
                    return;
                }
                
                if (!data.queries || data.queries.length === 0) {
                    modalContent.innerHTML = '<div class="loading">No queries found for this action type.</div>';
                    return;
                }

                const actionIcons = {
                    'Allowed': '‚úÖ',
                    'Blocked': 'üö´',
                    'Safe Search': 'üîç',
                    'Override Applied': '‚ö°',
                    'Unknown': '‚ùì'
                };

                const actionColors = {
                    'Allowed': 'var(--accent-success)',
                    'Blocked': 'var(--accent-error)',
                    'Safe Search': 'var(--accent-warning)',
                    'Override Applied': 'rgb(170, 110, 198)',
                    'Unknown': 'rgb(95, 99, 104)'
                };
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
                `;
                
                data.queries.slice(0, 50).forEach(query => {
                    const icon = actionIcons[actionType] || 'üìã';
                    const color = actionColors[actionType] || 'var(--text-primary)';
                    html += `
                        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; border: 1px solid var(--border-primary);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 1.2rem;">${icon}</span>
                                <span style="font-family: 'Roboto Mono', monospace; font-size: 0.85rem; font-weight: 600; color: ${color};">${actionType}</span>
                            </div>
                            <div style="font-family: 'Roboto Mono', monospace; font-size: 0.8rem; color: var(--text-primary); word-break: break-all; margin-bottom: 6px;">
                                ${query.queryName || 'Unknown Domain'}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-family: 'Roboto Mono', monospace; font-size: 0.7rem; color: var(--text-tertiary);">
                                    ${query.policyName || 'Default Policy'}
                                </span>
                                <span style="font-family: 'Roboto Mono', monospace; font-size: 0.7rem; color: var(--text-secondary); background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">
                                    ${query.count.toLocaleString()}
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                if (data.queries.length > 50) {
                    html += `<div style="text-align: center; margin-top: 16px; color: var(--text-tertiary); font-family: 'Roboto Mono', monospace; font-size: 0.8rem;">Showing 50 of ${data.queries.length} queries</div>`;
                }
                
                modalContent.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading action details:', error);
                modalContent.innerHTML = '<div style="color: var(--accent-error); text-align: center; padding: 20px;">Failed to load action details</div>';
            }
        }

        function renderSecurityDashboard(data) {
            document.getElementById('securityBlockRate').textContent = data.blockRate + '%';
            document.getElementById('securityAllowed').textContent = data.allowedQueries.toLocaleString();
            document.getElementById('securityBlocked').textContent = data.blockedQueries.toLocaleString();
            document.getElementById('securitySafeSearch').textContent = data.safeSearchQueries.toLocaleString();
        }

        let availableCountries = [];

        let availableCountriesData = [];

        function populateCountryDropdown(data) {
            availableCountriesData = data;
        }

        function showQueryInfo(chartType) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modal.style.display = 'block';
            
            // Special handling for timeline info
            if (chartType === 'timeline') {
                modalTitle.textContent = 'How to Read the DNS Query Timeline';
                modalContent.innerHTML = `
                    <div style="font-family: 'Roboto Mono', monospace;">
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">üìà Understanding the Chart</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6;">
                            The DNS Query Timeline shows the total number of DNS queries processed over time. 
                            This helps you identify traffic patterns and anomalies in your network.
                        </p>
                        
                        <h4 style="color: var(--text-primary); margin-bottom: 8px;">Time Ranges:</h4>
                        <ul style="color: var(--text-secondary); margin-bottom: 16px; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Last 24 Hours:</strong> Shows hourly data points for the past 24 hours</li>
                            <li><strong>Last 7 Days:</strong> Shows daily totals for each of the past 7 days</li>
                            <li><strong>Last 30 Days:</strong> Shows daily totals for each of the past 30 days</li>
                        </ul>
                        
                        <h4 style="color: var(--text-primary); margin-bottom: 8px;">What to Look For:</h4>
                        <ul style="color: var(--text-secondary); margin-bottom: 16px; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Spikes:</strong> Sudden increases may indicate unusual activity or attacks</li>
                            <li><strong>Patterns:</strong> Regular peaks during business hours are normal</li>
                            <li><strong>Drops:</strong> Significant decreases might indicate connectivity issues</li>
                        </ul>
                        
                        <h4 style="color: var(--text-primary); margin-bottom: 8px;">Data Included:</h4>
                        <p style="color: var(--text-secondary); line-height: 1.6;">
                            The total includes all DNS query types: Allowed, Blocked, Safe Search, Override Applied, and Unknown decisions.
                        </p>
                    </div>
                `;
                return;
            }

            const queries = {
                geography: {
                    title: 'DNS Queries by Geography',
                    description: 'Groups DNS queries by source IP country code',
                    dimensions: 'srcIpCountry',
                    endpoint: '/dns/api/geography'
                },
                category: {
                    title: 'DNS Queries by Category',
                    description: 'Groups DNS queries by content category',
                    dimensions: 'categoryIds',
                    endpoint: '/dns/api/category-filtered'
                },
                action: {
                    title: 'DNS Action Breakdown',
                    description: 'Groups DNS queries by resolver decision (allowed, blocked, safe search, etc.)',
                    dimensions: 'resolverDecision',
                    endpoint: '/dns/api/action-breakdown'
                },
                trend: {
                    title: 'Query Trends',
                    description: 'Daily DNS query counts grouped by resolver decision over time',
                    dimensions: 'datetimeHour, resolverDecision',
                    endpoint: '/dns/api/30day'
                },
                allowed: {
                    title: 'Top Allowed Categories',
                    description: 'Top 20 content categories for allowed DNS queries',
                    dimensions: 'categoryIds (resolverDecision_in: [1,4,5,10])',
                    endpoint: '/dns/api/top-allowed'
                },
                blocked: {
                    title: 'Top Blocked Categories',
                    description: 'Top 20 content categories for blocked DNS queries',
                    dimensions: 'categoryIds (resolverDecision_in: [2,3,6,9])',
                    endpoint: '/dns/api/top-blocked'
                },
                queries: {
                    title: 'Top Queried Domains',
                    description: 'Top 20 most queried domain names',
                    dimensions: 'queryName',
                    endpoint: '/dns/api/top-queries'
                }
            };

            const info = queries[chartType];
            if (!info) return;

            const now = new Date();
            let startDate;
            if (currentTimeRange === '24h') {
                startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            } else if (currentTimeRange === '7d') {
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            } else {
                startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            }

            modalTitle.textContent = info.title + ' - Query Info';
            
            const graphqlQuery = `query {
  viewer {
    accounts(filter: {accountTag: "YOUR_ACCOUNT_ID"}) {
      gatewayResolverQueriesAdaptiveGroups(
        filter: {
          datetime_geq: "${startDate.toISOString()}"
          datetime_leq: "${now.toISOString()}"
        }
        limit: 10000
        orderBy: [count_DESC]
      ) {
        count
        dimensions {
          ${info.dimensions}
        }
      }
    }
  }
}`;

            const curlCommand = `curl -X POST https://api.cloudflare.com/client/v4/graphql \\
  -H "Authorization: Bearer YOUR_API_TOKEN" \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify({ query: graphqlQuery.replace(/\n/g, ' ').replace(/\s+/g, ' ') })}'`;

            modalContent.innerHTML = '<div style="margin-bottom: 20px;">' +
                '<h3 style="color: var(--text-primary); margin-bottom: 10px;">Description</h3>' +
                '<p style="color: var(--text-secondary);">' + info.description + '</p>' +
                '</div>' +
                '<div style="margin-bottom: 20px;">' +
                '<h3 style="color: var(--text-primary); margin-bottom: 10px;">API Endpoint</h3>' +
                '<code style="background: var(--bg-tertiary); padding: 8px 12px; border-radius: 6px; display: block; color: var(--accent-primary);">' + info.endpoint + '?timeRange=' + currentTimeRange + '</code>' +
                '</div>' +
                '<div style="margin-bottom: 20px;">' +
                '<h3 style="color: var(--text-primary); margin-bottom: 10px;">GraphQL Query</h3>' +
                '<pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.85rem; color: var(--text-secondary); white-space: pre-wrap; word-break: break-all;">' + graphqlQuery + '</pre>' +
                '</div>' +
                '<div>' +
                '<h3 style="color: var(--text-primary); margin-bottom: 10px;">cURL Command</h3>' +
                '<pre style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.85rem; color: var(--text-secondary); white-space: pre-wrap; word-break: break-all;">' + curlCommand + '</pre>' +
                '</div>';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Live logs functions
        async function fetchLiveLogs() {
            try {
                let url = '/dns/api/live-logs';
                // Don't use since parameter initially to get all recent logs
                
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('Live logs API error:', response.status);
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Live logs API returned error:', data.error);
                    return;
                }
                
                if (data.logs && data.logs.length > 0) {
                    // Add new logs to the beginning (newest first)
                    const newLogs = data.logs.filter(log => {
                        // Avoid duplicates based on domain + timestamp + action
                        return !allLogs.some(existing => 
                            existing.domain === log.domain && 
                            existing.timestamp === log.timestamp &&
                            existing.action === log.action
                        );
                    });
                    
                    if (newLogs.length > 0) {
                        allLogs = [...newLogs, ...allLogs].slice(0, MAX_LOGS);
                        renderLogs();
                    }
                }
                
                if (data.serverTime) {
                    lastLogTimestamp = data.serverTime;
                }
            } catch (error) {
                console.error('Error fetching live logs:', error);
            }
        }

        function renderLogs() {
            const tbody = document.getElementById('liveLogsBody');
            const noLogsMessage = document.getElementById('noLogsMessage');
            const logCount = document.getElementById('logCount');
            
            if (allLogs.length === 0) {
                tbody.innerHTML = '';
                noLogsMessage.style.display = 'block';
                logCount.textContent = '0 logs';
                return;
            }
            
            noLogsMessage.style.display = 'none';
            logCount.textContent = allLogs.length + ' logs';
            
            tbody.innerHTML = allLogs.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString();
                const categories = log.categories.length > 0 ? log.categories.join(', ') : '-';
                const policy = log.policy || '-';
                const count = log.count || 1;
                const actionColor = log.isBlocked ? 'var(--accent-error)' : 'var(--accent-success)';
                const rowBg = log.isBlocked ? 'rgba(220, 38, 38, 0.05)' : '';
                
                return `<tr style="border-bottom: 1px solid var(--border-secondary); background: ${rowBg};">
                    <td style="padding: 8px 12px; white-space: nowrap;">${time}</td>
                    <td style="padding: 8px 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${log.domain}">${log.domain}</td>
                    <td style="padding: 8px 12px; color: var(--text-secondary); max-width: 120px; overflow: hidden; text-overflow: ellipsis;" title="${categories}">${categories}</td>
                    <td style="padding: 8px 12px; color: var(--text-secondary); max-width: 120px; overflow: hidden; text-overflow: ellipsis;" title="${policy}">${policy}</td>
                    <td style="padding: 8px 12px; text-align: right;">${count}</td>
                    <td style="padding: 8px 12px; color: ${actionColor}; font-weight: 500;">${log.action}</td>
                </tr>`;
            }).join('');
        }

        function clearLogs() {
            allLogs = [];
            lastLogTimestamp = null;
            renderLogs();
        }

        loadDashboardData('7d');
    </script>
</body>
</html>
